#!/usr/bin/env node
/*eslint-disable */

var path = require('path');
var execFileSync = require('child_process').execFileSync;
var commander = require('commander');
var readPackageSync = require(path.resolve(
  __dirname,
  '../lib/utils/readPackageSync'
));
var hashFiles = require(path.resolve(__dirname, '../lib/utils/hashFiles'));

function parseBool(v) {
  return v === 'true' || v === '1' ? true : false;
}

var paths;
var args = [];
var chainscriptArgs = [];
var execChainscript = false;

process.argv.forEach(function(arg) {
  if (arg === '--') {
    execChainscript = true;
    return;
  }

  if (execChainscript) {
    chainscriptArgs.push(arg);
  } else {
    args.push(arg);
  }
});

commander
  .version(readPackageSync('version'))
  .usage('[options] [path...] [-- chainscript args]')
  .option('-a, --algorithm <name>', 'hash algorithm (default md5)')
  .option('-r, --root <path>', 'JSON root path')
  .parse(args);

if (commander.args.length > 0) {
  paths = commander.args.map(function(p) {
    return path.resolve(process.cwd(), p);
  });
} else {
  paths = [process.cwd()];
}

function handleOutput(output) {
  var str = JSON.stringify(output, null, '\t') + '\n';
  var res = process.stdout.write(str, function() {
    process.exit(0);
  });

  if (!res) {
    handleError(new Error('Failed to write output'));
  }
}

function handleError(err) {
  process.stderr.write(err.message + '\n', function() {
    process.exit(1);
  });
}

hashFiles(process.cwd(), paths, commander.algorithm, commander.root)
  .then(function(json) {
    if (execChainscript) {
      var hasAt = false;

      for (var i = 0; i < chainscriptArgs.length; i++) {
        var arg = chainscriptArgs[i];

        if (arg === '@') {
          chainscriptArgs[i] = JSON.stringify(json);
          hasAt = true;
        }
      }
      try {
        execFileSync(
          path.resolve(__dirname, './chainscript'),
          chainscriptArgs,
          {
            input: hasAt ? null : JSON.stringify(json),
            stdio: [null, process.stdout, process.stderr]
          }
        );
      } catch(err) {
        handleError(err);
      }

      return;
    }
    
    handleOutput(json);
  })
  .catch(handleError);
