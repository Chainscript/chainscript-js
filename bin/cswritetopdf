#!/usr/bin/env node
/*eslint-disable */

var path = require('path');
var commander = require('commander');
var readPackageSync = require(path.resolve(
  __dirname,
  '../lib/utils/readPackageSync'
));
var writeToPDF = require(path.resolve(__dirname, '../lib/utils/writeToPDF'));

function handleInput(input) {
  try {
    var json = JSON.parse(input);
    writeToPDF(
      path.resolve(process.cwd(), commander.args[0]),
      path.resolve(process.cwd(), commander.args[1]),
      json
    )
      .then(function() {
        process.exit(0);
      })
      .catch(handleError);
  } catch(err) {
    handleError(err);
  }
}

function handleError(err) {
  process.stderr.write(err.message + '\n', function() {
    process.exit(1);
  });
}

commander
  .version(readPackageSync('version'))
  .usage('[options] input output [json]')
  .parse(process.argv);

if (commander.args.length < 2 || commander.args.length > 3) {
  commander.outputHelp();
  process.exit(1);
}

if (commander.args.length === 2) {
  process.stdin.setEncoding('utf8');

  var input = '';

  process.stdin.on('readable', function() {
    var chunk = process.stdin.read();

    if (chunk !== null) {
      input += chunk.toString();
    }
  });

  process.stdin.on('end', function() {
    input = input.replace(/\n$/, '');

    if (input.length) {
      handleInput(input);
    } else {
      commander.outputHelp();
      process.exit(1);
    }
  });
} else {
  handleInput(commander.args[2]);
}
