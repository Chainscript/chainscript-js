#!/usr/bin/env node
/*eslint-disable */

var path = require('path');
var commander = require('commander');
var verifyFiles = require(path.resolve(__dirname, '../lib/utils/verifyFiles'));

commander
  .version('0.9.0')
  .usage('[options]')
  .option('-r, --root <path>', 'JSON root path')
  .parse(process.argv);

function handleInput(input) {
  try {
    var json = JSON.parse(input);
    verifyFiles(process.cwd(), json.body.content, commander.root)
      .then(function() {
        process.stdout.write('Success\n');
        process.exit(0);
      })
      .catch(function(err) {
        process.stderr.write(err.message + '\n');
        process.exit(1);
      });
  } catch(err) {
    process.stderr.write(err.message + '\n');
    process.exit(1);
  }
}

if (commander.args.length === 0) {
  process.stdin.setEncoding('utf8');

  var input = '';

  process.stdin.on('readable', function() {
    var chunk = process.stdin.read();
    if (chunk !== null) {
      input += chunk.toString();
    }
  });

  process.stdin.on('end', function() {
    input = input.replace(/\n$/, '');

    if (input.length) {
      handleInput(input);
    } else {
      commander.outputHelp();
      process.exit(1);
    }
  });
} else {
  handleInput(commander.args[0]);
}
